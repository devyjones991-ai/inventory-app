# Настройка администрирования

## Обзор

В приложении добавлена система управления пользователями, которая позволяет администраторам:
- Просматривать список всех пользователей
- Изменять роли пользователей (пользователь/администратор)
- Создавать новых администраторов
- Удалять пользователей

## Настройка

### 1. Применение миграций

Выполните миграцию для создания таблицы профилей:

```bash
supabase db push
```

### 2. Создание первого администратора

#### Способ 1: Через Supabase Dashboard

1. Откройте Supabase Dashboard
2. Перейдите в раздел "Authentication" > "Users"
3. Создайте нового пользователя с email администратора
4. Перейдите в раздел "Table Editor" > "profiles"
5. Найдите созданного пользователя и измените роль на "admin"

#### Способ 2: Через SQL

```sql
-- Замените 'admin@example.com' на email администратора
UPDATE profiles 
SET role = 'admin' 
WHERE email = 'admin@example.com';
```

#### Способ 3: Через приложение (если уже есть админ)

1. Войдите в приложение как администратор
2. Откройте профиль (кликните на аватар)
3. Нажмите "Панель администратора"
4. Используйте кнопку "Создать администратора"

### 3. Доступ к админке

После создания администратора:

1. Войдите в приложение
2. Откройте профиль (кликните на аватар в правом верхнем углу)
3. В разделе "Администрирование" нажмите "Панель администратора"
4. Или перейдите напрямую по адресу `/admin`

## Функции админки

### Управление пользователями

- **Просмотр списка**: Все пользователи отображаются с информацией о роли, дате создания и последнем входе
- **Редактирование**: Изменение имени и роли пользователя
- **Удаление**: Удаление пользователей (кроме себя)
- **Создание админов**: Создание новых администраторов по email

### Безопасность

- Доступ только для пользователей с ролью "admin"
- RLS (Row Level Security) настроен для защиты данных
- Администраторы не могут удалить самих себя
- Все операции логируются

## Структура базы данных

### Таблица `profiles`

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  role TEXT DEFAULT 'user' CHECK (role IN ('user', 'admin')),
  backup_email TEXT,
  phone TEXT,
  position TEXT,
  department TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_sign_in_at TIMESTAMP WITH TIME ZONE
);
```

### Политики безопасности

- Пользователи видят только свой профиль
- Администраторы видят все профили
- Администраторы могут изменять все профили
- Администраторы могут удалять профили (кроме своего)

## Устранение неполадок

### Проблема: "Доступ запрещен"

**Причина**: Пользователь не имеет роли "admin"

**Решение**: 
1. Проверьте роль пользователя в таблице `profiles`
2. Установите роль "admin" для нужного пользователя

### Проблема: Не отображается кнопка "Панель администратора"

**Причина**: Пользователь не является администратором

**Решение**: Убедитесь, что в таблице `profiles` для пользователя установлена роль "admin"

### Проблема: Ошибка при создании администратора

**Причина**: Возможные проблемы с правами доступа или конфигурацией

**Решение**:
1. Проверьте, что у текущего пользователя есть права администратора
2. Убедитесь, что Supabase настроен правильно
3. Проверьте логи в консоли браузера

## Разработка

### Добавление новых функций

Для добавления новых функций администрирования:

1. Обновите компонент `AdminPage.tsx`
2. Добавьте необходимые поля в таблицу `profiles`
3. Обновите политики безопасности
4. Добавьте соответствующие тесты

### Тестирование

```bash
# Запуск тестов
npm test

# Запуск тестов для админки
npm test -- AdminPage
```

## Безопасность

⚠️ **Важно**: 
- Никогда не передавайте права администратора неавторизованным пользователям
- Регулярно проверяйте список администраторов
- Используйте сильные пароли для административных аккаунтов
- Ведите аудит изменений ролей пользователей
