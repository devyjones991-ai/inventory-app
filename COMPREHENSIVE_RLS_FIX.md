# Комплексное исправление RLS политик

## Проблемы, которые решает эта миграция

1. **Рекурсия в profiles**: `is_superuser()` делал SELECT из profiles внутри политик, вызывая бесконечную рекурсию
2. **Конфликт политик для objects**: разные миграции создавали противоречащие политики чтения
3. **Новые пользователи не видят объекты**: политика "Members can read objects" блокировала доступ
4. **Зависимости функций**: `get_all_profiles()` могла не работать, если `get_user_role_cached()` не существовала

## Решение

### Миграция: `20250902000017_comprehensive-fix-rls-policies.sql`

Эта миграция:

1. **Пересоздает все функции с правильными зависимостями**:
   - `get_user_role_cached()` - базовая функция с SECURITY DEFINER для получения роли без рекурсии
   - `is_superuser()` - использует `get_user_role_cached()`, не делает SELECT напрямую
   - `is_admin()` - использует `get_user_role_cached()`, не делает SELECT напрямую
   - `get_all_profiles()` - использует `get_user_role_cached()` для проверки прав

2. **Удаляет все конфликтующие политики**:
   - Удаляет все старые политики для profiles, objects, hardware, tasks, chat_messages

3. **Создает правильные политики**:
   - **Profiles**: пользователи видят свой профиль, superuser/admin видят все профили
   - **Objects**: все аутентифицированные могут читать и создавать, только члены могут изменять/удалять
   - **Hardware/Tasks/Chat**: все могут читать, только члены могут изменять

## Применение

### На сервере:

```bash
cd ~/inventory-app
git pull origin main
./apply-comprehensive-rls-fix.sh
```

Или вручную:

```bash
psql "postgresql://postgres:postgres@127.0.0.1:54322/postgres" -f supabase/migrations/20250902000017_comprehensive-fix-rls-policies.sql
```

### Проверка:

После применения миграции проверьте:

1. ✅ Superuser может загрузить список пользователей в администрировании
2. ✅ Новые пользователи видят объекты (хотя бы названия)
3. ✅ Нет ошибок "infinite recursion detected"
4. ✅ Все функции работают корректно

## Что изменилось в клиентском коде

### `src/hooks/useObjectList.js`
- Добавлена обработка ошибок RLS и рекурсии
- Улучшены сообщения об ошибках

### `src/components/ProfileSettings.tsx`
- Улучшена обработка ошибок при загрузке списка пользователей
- Более информативные сообщения об ошибках для superuser/admin
- Правильная обработка случая, когда пользователей нет (не ошибка)

## Важные замечания

1. **Порядок политик важен**: PostgreSQL объединяет политики через OR, поэтому superuser может всё через свою политику, а обычные пользователи - через другие

2. **SECURITY DEFINER**: Все функции используют SECURITY DEFINER для обхода RLS, что предотвращает рекурсию

3. **Новые пользователи**: Теперь все аутентифицированные пользователи могут видеть объекты (хотя бы названия), что решает проблему "только кнопка создать первый объект"

4. **Superuser**: Superuser может управлять всеми объектами, профилями и данными через специальные политики

## Откат (если нужно)

Если миграция вызвала проблемы, можно откатить вручную:

```sql
-- ВНИМАНИЕ: Это удалит все политики, созданные миграцией
-- Нужно будет восстановить их вручную или применить предыдущие миграции

DROP POLICY IF EXISTS "Users can view own profile" ON profiles;
DROP POLICY IF EXISTS "Superuser can view all profiles" ON profiles;
DROP POLICY IF EXISTS "Admins can view all profiles" ON profiles;
-- ... и так далее для всех политик
```

Однако рекомендуется не откатывать миграцию, а исправлять проблемы по мере их обнаружения.

