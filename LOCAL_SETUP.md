# Настройка полностью локального Supabase

Этот проект настроен для работы **только с локальной БД** без ссылок на удаленный Supabase.

## Быстрый старт

### 1. Запустите скрипт настройки

```bash
bash setup-local-supabase.sh
```

Скрипт автоматически:
- ✅ Удалит все ссылки на удаленный Supabase
- ✅ Проверит и исправит конфигурацию
- ✅ Запустит локальный Supabase
- ✅ Создаст `.env.local` с локальными значениями
- ✅ Применит все миграции

### 2. Проверьте статус

```bash
supabase status
```

Вы увидите локальные URL (127.0.0.1 или localhost), **НЕ** *.supabase.co

### 3. Используйте приложение

Приложение автоматически использует значения из `.env.local` для подключения к локальному Supabase.

## Структура файлов

- **`supabase/config.toml`** - упрощенная локальная конфигурация (PostgreSQL 15)
- **`.env.local`** - локальные переменные окружения (не коммитится в git)
- **`public/env.js`** - оставлен пустым, использует значения из .env
- **`.supabase/`** - игнорируется в git (не коммитится)

## Полезные команды

```bash
# Статус и конфигурация
supabase status

# Остановить/запустить
supabase stop
supabase start
supabase restart

# Работа с БД
supabase db reset          # Сбросить БД и применить все миграции (удалит данные!)
supabase db push           # Применить только новые миграции (сохраняет данные)
supabase migration list    # Список примененных миграций

# Веб-интерфейс
# Откройте в браузере: http://localhost:54323
```

## Порты

- **54321** - Supabase API (REST API)
- **54322** - PostgreSQL (прямое подключение)
- **54323** - Supabase Studio (веб-интерфейс)
- **54324** - Inbucket (тестовый email сервер)

## Доступ извне (если нужно)

Если приложение должно быть доступно не только с localhost:

1. Получите IP сервера:
```bash
hostname -I | awk '{print $1}'
```

2. Обновите `.env.local`:
```bash
# Замените 127.0.0.1 на IP сервера
sed -i 's/127.0.0.1/YOUR_SERVER_IP/g' .env.local
```

3. Обновите `supabase/config.toml`:
```bash
sed -i 's|http://127.0.0.1|http://YOUR_SERVER_IP|g' supabase/config.toml
```

4. Перезапустите Supabase:
```bash
supabase restart
```

## Решение проблем

### Ошибка "Cannot find project ref"

```bash
# Удалите ссылки на удаленный проект
rm -rf .supabase/
bash setup-local-supabase.sh
```

### Ошибка "Invalid db.major_version: 17"

Конфигурация уже исправлена на версию 15. Если ошибка остается:
```bash
sed -i 's/major_version = 17/major_version = 15/' supabase/config.toml
```

### Миграции не применяются

```bash
# Примените миграции вручную
supabase db reset
```

### Применение новых миграций

После получения обновлений из репозитория (например, через `git pull`), новые миграции нужно применить к локальной БД:

```bash
# Вариант 1: Применить только новые миграции (рекомендуется, сохраняет данные)
supabase db push

# Вариант 2: Сбросить БД и применить все миграции заново (удалит все данные!)
supabase db reset
```

**Рекомендация:** Используйте `supabase db push` для применения новых миграций, чтобы не потерять существующие данные.

Проверить список примененных миграций:
```bash
supabase migration list
```

### Проблемы с регистрацией

Убедитесь, что:
1. Supabase запущен: `supabase status`
2. Миграции применены: `supabase migration list`
3. Таблица `profiles` существует: подключитесь к БД и проверьте `\dt profiles`

## Важно

- ✅ Все данные хранятся **локально** на сервере
- ✅ Нет подключений к удаленному Supabase
- ✅ `.env.local` и `.supabase/` **не коммитятся** в git
- ✅ Конфигурация оптимизирована для локальной работы

